# æŠ¥å‘Šå¯¼å‡ºç•Œé¢

<cite>
**æœ¬æ–‡å¼•ç”¨çš„æ–‡ä»¶**
- [page_export.py](file://ui/components/page_export.py)
- [report_utils.py](file://utils/report_utils.py)
- [stock_report.py](file://stock/stock_report.py)
- [market_report.py](file://market/market_report.py)
- [page_stock.py](file://ui/components/page_stock.py)
- [APIæ–‡æ¡£](file://ui/components/API_DOCUMENTATION.md)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹
æœ¬æ–‡ä»¶æ˜¯â€œæŠ¥å‘Šå¯¼å‡ºç•Œé¢â€çš„APIå‚è€ƒæ–‡æ¡£ï¼Œèšç„¦äºå¯¼å‡ºåŠŸèƒ½ç»„ä»¶ä¸­çš„ä¸‰ä¸ªæ ¸å¿ƒå‡½æ•°ï¼šdisplay_report_export_sectionã€display_quick_export_buttonsã€display_batch_export_optionsã€‚æ–‡æ¡£è¯¦ç»†è¯´æ˜å„å‡½æ•°çš„å‚æ•°ã€è¡Œä¸ºã€Session Stateä½¿ç”¨æ¨¡å¼ï¼Œå¹¶è§£é‡Šæ”¯æŒçš„å¯¼å‡ºæ ¼å¼ï¼ˆPDFã€DOCXã€Markdownã€HTMLï¼‰åŠå…¶MIMEç±»å‹ã€‚åŒæ—¶æä¾›å¦‚ä½•é›†æˆè‡ªå®šä¹‰æŠ¥å‘Šç”Ÿæˆå‡½æ•°çš„å®Œæ•´ç¤ºä¾‹ï¼Œå±•ç¤ºä»æ•°æ®è·å–åˆ°æŠ¥å‘Šç”Ÿæˆçš„ç«¯åˆ°ç«¯æµç¨‹ã€‚

## é¡¹ç›®ç»“æ„
å¯¼å‡ºåŠŸèƒ½ä¸»è¦ä½äºUIç»„ä»¶å±‚ï¼Œç»“åˆé€šç”¨æŠ¥å‘Šå·¥å…·è¿›è¡Œæ ¼å¼è½¬æ¢ä¸è¾“å‡ºã€‚å…³é”®æ–‡ä»¶å¦‚ä¸‹ï¼š
- ui/components/page_export.pyï¼šå¯¼å‡ºç•Œé¢ç»„ä»¶ä¸äº¤äº’é€»è¾‘
- utils/report_utils.pyï¼šPDF/DOCX/Markdown/HTMLç”Ÿæˆå·¥å…·ä¸ç¯å¢ƒæ£€æµ‹
- stock/stock_report.pyï¼šè‚¡ç¥¨æŠ¥å‘Šç”Ÿæˆå™¨ï¼ˆè¿”å›Markdownæˆ–äºŒè¿›åˆ¶å†…å®¹ï¼‰
- market/market_report.pyï¼šå¸‚åœºæŠ¥å‘Šç”Ÿæˆå™¨ï¼ˆè¿”å›Markdownæˆ–äºŒè¿›åˆ¶å†…å®¹ï¼‰
- ui/components/page_stock.pyï¼šåœ¨è‚¡ç¥¨é¡µé¢ä¸­é›†æˆå¯¼å‡ºåŠŸèƒ½çš„ç¤ºä¾‹
- ui/components/API_DOCUMENTATION.mdï¼šå¯¼å‡ºæ ¼å¼ä¸Session Stateä½¿ç”¨è¯´æ˜

```mermaid
graph TB
subgraph "UIç»„ä»¶å±‚"
A["page_export.py<br/>å¯¼å‡ºç•Œé¢ç»„ä»¶"]
B["page_stock.py<br/>è‚¡ç¥¨é¡µé¢é›†æˆç¤ºä¾‹"]
end
subgraph "ä¸šåŠ¡ç”Ÿæˆå±‚"
C["stock_report.py<br/>è‚¡ç¥¨æŠ¥å‘Šç”Ÿæˆå™¨"]
D["market_report.py<br/>å¸‚åœºæŠ¥å‘Šç”Ÿæˆå™¨"]
end
subgraph "å·¥å…·å±‚"
E["report_utils.py<br/>PDF/DOCX/HTML/Markdownç”Ÿæˆå·¥å…·"]
end
A --> E
B --> A
B --> C
C --> E
D --> E
```

å›¾è¡¨æ¥æº
- [page_export.py](file://ui/components/page_export.py#L1-L457)
- [report_utils.py](file://utils/report_utils.py#L1-L330)
- [stock_report.py](file://stock/stock_report.py#L1-L311)
- [market_report.py](file://market/market_report.py#L1-L114)
- [page_stock.py](file://ui/components/page_stock.py#L1-L200)

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L1-L457)
- [report_utils.py](file://utils/report_utils.py#L1-L330)
- [stock_report.py](file://stock/stock_report.py#L1-L311)
- [market_report.py](file://market/market_report.py#L1-L114)
- [page_stock.py](file://ui/components/page_stock.py#L1-L200)

## æ ¸å¿ƒç»„ä»¶
æœ¬èŠ‚å¯¹ä¸‰ä¸ªæ ¸å¿ƒå¯¼å‡ºå‡½æ•°è¿›è¡Œå‚æ•°ä¸è¡Œä¸ºè¯´æ˜ï¼Œå¹¶æŒ‡å‡ºå…¶ä¸Session Stateçš„äº¤äº’æ¨¡å¼ã€‚

- display_report_export_section(entity_id, report_type="report", title="ğŸ“‹ å¯¼å‡ºæŠ¥å‘Š", info_text="ğŸ’¡ å¯ä»¥å¯¼å‡ºå®Œæ•´çš„åˆ†ææŠ¥å‘Š", generate_func=None, generate_args=None, filename_prefix="æŠ¥å‘Š")
  - åŠŸèƒ½ï¼šå±•ç¤ºå®Œæ•´çš„å¯¼å‡ºåŒºåŸŸï¼ŒåŒ…å«æ ¼å¼é€‰æ‹©ã€ç”ŸæˆæŒ‰é’®ã€ä¸‹è½½æŒ‰é’®ä¸ç”ŸæˆçŠ¶æ€æç¤ºã€‚
  - å…³é”®å‚æ•°ï¼š
    - entity_idï¼šå®ä½“æ ‡è¯†ï¼ˆå¦‚è‚¡ç¥¨ä»£ç æˆ–æŒ‡æ•°åç§°ï¼‰ï¼Œç”¨äºåŒºåˆ†ä¸åŒæŠ¥å‘Šå®ä¾‹ã€‚
    - report_typeï¼šæŠ¥å‘Šç±»å‹æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†ä¸åŒé¡µé¢æˆ–ä¸šåŠ¡åŸŸçš„æŠ¥å‘Šé›†åˆã€‚
    - generate_funcï¼šè‡ªå®šä¹‰æŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼Œéœ€æ¥æ”¶format_typeå…³é”®å­—å‚æ•°å¹¶è¿”å›å¯¹åº”æ ¼å¼çš„å†…å®¹ï¼ˆå­—ç¬¦ä¸²æˆ–äºŒè¿›åˆ¶ï¼‰ã€‚
    - generate_argsï¼šä¼ é€’ç»™generate_funcçš„å‚æ•°å…ƒç»„ï¼›è‹¥ä¸ºç©ºï¼Œåˆ™ä»…ä¼ å…¥format_typeã€‚
    - filename_prefixï¼šç”Ÿæˆæ–‡ä»¶çš„å‰ç¼€ï¼Œæœ€ç»ˆæ–‡ä»¶åä¸ºâ€œå‰ç¼€_å®ä½“ID_æ—¶é—´æˆ³.æ‰©å±•åâ€ã€‚
  - è¡Œä¸ºè¦ç‚¹ï¼š
    - è‡ªåŠ¨æ ¹æ®ç¯å¢ƒæ£€æµ‹PDFæ”¯æŒï¼ŒåŠ¨æ€è°ƒæ•´å¯ç”¨æ ¼å¼åˆ—è¡¨ã€‚
    - ç”ŸæˆæŒ‰é’®è§¦å‘åï¼Œè°ƒç”¨handle_report_generationæ‰§è¡Œç”Ÿæˆä¸å­˜å‚¨ã€‚
    - ä¸‹è½½æŒ‰é’®åœ¨ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºï¼Œè¯»å–Session Stateä¸­çš„å†…å®¹ã€æ–‡ä»¶åã€MIMEç±»å‹å¹¶è§¦å‘ä¸‹è½½ã€‚
  - Session Stateä½¿ç”¨æ¨¡å¼ï¼š
    - ç”ŸæˆæœŸé—´è®¾ç½®â€œgenerating_{report_type}_{entity_id}â€é”®ä»¥æ ‡è®°ç”Ÿæˆä¸­çŠ¶æ€ã€‚
    - ç”ŸæˆæˆåŠŸåå†™å…¥ä»¥ä¸‹é”®ï¼š
      - "{report_type}_content_{entity_id}"ï¼šæŠ¥å‘Šå†…å®¹ï¼ˆå­—ç¬¦ä¸²æˆ–äºŒè¿›åˆ¶ï¼‰
      - "{report_type}_filename_{entity_id}"ï¼šæ–‡ä»¶å
      - "{report_type}_mime_{entity_id}"ï¼šMIMEç±»å‹
      - "{report_type}_format_{entity_id}"ï¼šæ ¼å¼ç±»å‹
      - "{report_type}_timestamp_{entity_id}"ï¼šç”Ÿæˆæ—¶é—´æˆ³
    - ç”Ÿæˆå¤±è´¥æˆ–å¼‚å¸¸æ—¶æ¸…é™¤ç”ŸæˆçŠ¶æ€å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚

- display_quick_export_buttons(entity_id, report_type="report", generate_func=None, generate_args=None, filename_prefix="æŠ¥å‘Š")
  - åŠŸèƒ½ï¼šåœ¨åŒä¸€è¡Œæ˜¾ç¤ºå¤šç§æ ¼å¼çš„å¿«é€Ÿå¯¼å‡ºæŒ‰é’®ï¼Œä¸€é”®ç”Ÿæˆå¯¹åº”æ ¼å¼ã€‚
  - å…³é”®å‚æ•°ï¼šåŒä¸Šã€‚
  - è¡Œä¸ºè¦ç‚¹ï¼š
    - ä¸åŒ…å«æ ¼å¼é€‰æ‹©å™¨ï¼Œç›´æ¥æŒ‰å½“å‰å¯ç”¨æ ¼å¼é€ä¸€ç”Ÿæˆã€‚
    - æ¯ä¸ªæŒ‰é’®ç‚¹å‡»åè°ƒç”¨handle_report_generationå¹¶è§¦å‘é¡µé¢åˆ·æ–°ï¼ˆst.rerunï¼‰ã€‚

- display_batch_export_options(entities, report_type="report", generate_func=None, generate_args_func=None, filename_prefix="æŠ¥å‘Š")
  - åŠŸèƒ½ï¼šæ‰¹é‡å¯¼å‡ºå¤šä¸ªå®ä½“çš„æŠ¥å‘Šã€‚
  - å…³é”®å‚æ•°ï¼š
    - entitiesï¼šå®ä½“åˆ—è¡¨ï¼ˆå¦‚è‚¡ç¥¨ä»£ç åˆ—è¡¨ï¼‰ã€‚
    - generate_args_funcï¼šä¸ºæ¯ä¸ªå®ä½“ç”Ÿæˆå‚æ•°çš„å‡½æ•°ï¼Œè¾“å…¥ä¸ºå®ä½“IDï¼Œè¿”å›generate_funcæ‰€éœ€çš„å‚æ•°å…ƒç»„ã€‚
  - è¡Œä¸ºè¦ç‚¹ï¼š
    - æä¾›å¤šé€‰æ¡†é€‰æ‹©è¦å¯¼å‡ºçš„å®ä½“ï¼Œé»˜è®¤é€‰æ‹©å‰å‡ ä¸ªã€‚
    - é€‰æ‹©æ ¼å¼åç‚¹å‡»â€œæ‰¹é‡ç”ŸæˆæŠ¥å‘Šâ€ï¼Œé€ä¸ªå®ä½“è°ƒç”¨handle_report_generationå¹¶æ˜¾ç¤ºè¿›åº¦ä¸ç»Ÿè®¡ç»“æœã€‚
    - æ‰¹é‡å®Œæˆåæ˜¾ç¤ºæ¯ä¸ªå®ä½“çš„ä¸‹è½½æŒ‰é’®ã€‚

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L242-L457)

## æ¶æ„æ€»è§ˆ
ä¸‹å›¾å±•ç¤ºäº†ä»UIåˆ°ä¸šåŠ¡ç”Ÿæˆå†åˆ°å·¥å…·å±‚çš„è°ƒç”¨é“¾è·¯ï¼Œä»¥åŠSession Stateåœ¨å…¶ä¸­çš„ä½œç”¨ã€‚

```mermaid
sequenceDiagram
participant U as "ç”¨æˆ·"
participant UI as "page_export.py<br/>å¯¼å‡ºç•Œé¢ç»„ä»¶"
participant GEN as "ä¸šåŠ¡ç”Ÿæˆå‡½æ•°<br/>generate_func"
participant UTIL as "report_utils.py<br/>æ ¼å¼è½¬æ¢å·¥å…·"
participant SS as "Session State"
U->>UI : ç‚¹å‡»â€œç”ŸæˆæŠ¥å‘Šâ€æˆ–å¿«é€Ÿå¯¼å‡ºæŒ‰é’®
UI->>SS : è®¾ç½® generating_{report_type}_{entity_id}
UI->>GEN : è°ƒç”¨ generate_func(format_type=..., *generate_args)
alt è¿”å›Markdownå­—ç¬¦ä¸²
GEN->>UTIL : è°ƒç”¨å¯¹åº”æ ¼å¼ç”Ÿæˆå‡½æ•°PDF/DOCX/HTML/Markdown
UTIL-->>GEN : è¿”å›äºŒè¿›åˆ¶å†…å®¹æˆ–å­—ç¬¦ä¸²
else è¿”å›äºŒè¿›åˆ¶å†…å®¹
GEN-->>UI : ç›´æ¥è¿”å›äºŒè¿›åˆ¶å†…å®¹
end
UI->>SS : å†™å…¥ content/filename/mime/format/timestamp
UI->>U : æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
U->>UI : ç‚¹å‡»ä¸‹è½½
UI->>SS : è¯»å– content/filename/mime
UI-->>U : è§¦å‘æ–‡ä»¶ä¸‹è½½
```

å›¾è¡¨æ¥æº
- [page_export.py](file://ui/components/page_export.py#L110-L239)
- [report_utils.py](file://utils/report_utils.py#L80-L330)
- [stock_report.py](file://stock/stock_report.py#L16-L122)
- [market_report.py](file://market/market_report.py#L13-L87)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### å‡½æ•°ï¼šdisplay_report_export_section
- å‚æ•°è¯¦è§£
  - entity_idï¼šå®ä½“æ ‡è¯†ï¼Œç”¨äºSession Stateé”®æ‹¼æ¥ä¸æ–‡ä»¶å‘½åã€‚
  - report_typeï¼šæŠ¥å‘Šç±»å‹ï¼Œç”¨äºåŒºåˆ†ä¸åŒä¸šåŠ¡åŸŸçš„æŠ¥å‘Šé›†åˆã€‚
  - title/info_textï¼šç•Œé¢æ ‡é¢˜ä¸æç¤ºä¿¡æ¯ã€‚
  - generate_funcï¼šå¿…é¡»æä¾›ï¼Œç­¾åéœ€æ¥å—format_typeå…³é”®å­—å‚æ•°ï¼Œè¿”å›å­—ç¬¦ä¸²ï¼ˆMarkdownï¼‰æˆ–äºŒè¿›åˆ¶ï¼ˆPDF/DOCX/HTMLï¼‰ã€‚
  - generate_argsï¼šå¯é€‰ï¼Œä¼ é€’ç»™generate_funcçš„å‚æ•°å…ƒç»„ï¼›è‹¥ä¸ºç©ºï¼Œä»…ä¼ å…¥format_typeã€‚
  - filename_prefixï¼šæ–‡ä»¶åå‰ç¼€ï¼Œæœ€ç»ˆæ–‡ä»¶åä¸ºâ€œå‰ç¼€_å®ä½“ID_æ—¶é—´æˆ³.æ‰©å±•åâ€ã€‚

- Session Stateé”®è§„èŒƒ
  - generating_{report_type}_{entity_id}ï¼šç”Ÿæˆä¸­çŠ¶æ€
  - {report_type}_content_{entity_id}ï¼šç”Ÿæˆå†…å®¹
  - {report_type}_filename_{entity_id}ï¼šæ–‡ä»¶å
  - {report_type}_mime_{entity_id}ï¼šMIMEç±»å‹
  - {report_type}_format_{entity_id}ï¼šæ ¼å¼ç±»å‹
  - {report_type}_timestamp_{entity_id}ï¼šç”Ÿæˆæ—¶é—´æˆ³

- é”™è¯¯å¤„ç†
  - è‹¥æœªæä¾›generate_funcï¼Œç›´æ¥æŠ¥é”™å¹¶è¿”å›å¤±è´¥ã€‚
  - ç”Ÿæˆè¿‡ç¨‹ä¸­å¼‚å¸¸ä¼šæ•è·å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ŒåŒæ—¶æ¸…é™¤ç”ŸæˆçŠ¶æ€ã€‚

- ä¸æ ¼å¼é€‰æ‹©å™¨çš„åä½œ
  - é€šè¿‡display_format_selectorè·å–ç”¨æˆ·é€‰æ‹©çš„æ ¼å¼ç±»å‹ï¼Œå†äº¤ç”±handle_report_generationå¤„ç†ã€‚

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L242-L281)

### å‡½æ•°ï¼šdisplay_quick_export_buttons
- å‚æ•°è¯¦è§£
  - åŒdisplay_report_export_sectionï¼Œä½†ä¸åŒ…å«æ ¼å¼é€‰æ‹©å™¨ã€‚
  - æ¯ä¸ªæ ¼å¼æŒ‰é’®ç‚¹å‡»åç›´æ¥è°ƒç”¨handle_report_generationå¹¶è§¦å‘st.rerunã€‚

- ä½¿ç”¨åœºæ™¯
  - ç”¨æˆ·å¸Œæœ›å¿«é€Ÿå¯¼å‡ºå¤šç§æ ¼å¼ï¼Œæ— éœ€æ‰‹åŠ¨åˆ‡æ¢æ ¼å¼ã€‚

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L283-L317)

### å‡½æ•°ï¼šdisplay_batch_export_options
- å‚æ•°è¯¦è§£
  - entitiesï¼šå®ä½“åˆ—è¡¨ï¼Œå¦‚è‚¡ç¥¨ä»£ç åˆ—è¡¨ã€‚
  - generate_args_funcï¼šä¸ºæ¯ä¸ªå®ä½“ç”Ÿæˆå‚æ•°çš„å‡½æ•°ï¼Œè¾“å…¥ä¸ºå®ä½“IDï¼Œè¿”å›generate_funcæ‰€éœ€çš„å‚æ•°å…ƒç»„ã€‚
  - å…¶ä»–å‚æ•°ä¸å•ä½“å¯¼å‡ºä¸€è‡´ã€‚

- è¡Œä¸ºä¸å¯è§†åŒ–
  - å¤šé€‰æ¡†é»˜è®¤é€‰æ‹©å‰å‡ ä¸ªå®ä½“ã€‚
  - æ˜¾ç¤ºè¿›åº¦æ¡ä¸çŠ¶æ€æ–‡æœ¬ï¼Œç»Ÿè®¡æˆåŠŸæ•°é‡ã€‚
  - æˆåŠŸåé€ä¸ªæ˜¾ç¤ºä¸‹è½½æŒ‰é’®ã€‚

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L319-L391)

### æ”¯æŒçš„å¯¼å‡ºæ ¼å¼ä¸MIMEç±»å‹
- PDFï¼šæ‰©å±•å.pdfï¼ŒMIMEç±»å‹application/pdf
- DOCXï¼šæ‰©å±•å.docxï¼ŒMIMEç±»å‹application/vnd.openxmlformats-officedocument.wordprocessingml.document
- Markdownï¼šæ‰©å±•å.mdï¼ŒMIMEç±»å‹text/markdown
- HTMLï¼šæ‰©å±•å.htmlï¼ŒMIMEç±»å‹text/html

- ç¯å¢ƒæ£€æµ‹ä¸å¯ç”¨æ€§
  - PDFæ”¯æŒå–å†³äºPDF_SUPPORT_AVAILABLEï¼Œç”±report_utils.pyä¸­çš„ç¯å¢ƒæ£€æµ‹å†³å®šã€‚
  - å½“PDFä¸å¯ç”¨æ—¶ï¼Œç•Œé¢ä¼šè‡ªåŠ¨åˆ‡æ¢ä¸ºDOCXã€Markdownã€HTMLä¸‰æ ¼å¼ã€‚

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L18-L54)
- [report_utils.py](file://utils/report_utils.py#L1-L46)
- [APIæ–‡æ¡£](file://ui/components/API_DOCUMENTATION.md#L511-L519)

### Session Stateä½¿ç”¨æ¨¡å¼
- ç”Ÿæˆä¸­çŠ¶æ€
  - é”®ï¼šgenerating_{report_type}_{entity_id}
  - å€¼ï¼šå½“å‰æ ¼å¼ç±»å‹ï¼›ç”¨äºUIæç¤ºä¸é˜²é‡å¤æäº¤
- ç”Ÿæˆå®Œæˆåçš„å­˜å‚¨
  - contentï¼šç”Ÿæˆå†…å®¹ï¼ˆå­—ç¬¦ä¸²æˆ–äºŒè¿›åˆ¶ï¼‰
  - filenameï¼šæ–‡ä»¶å
  - mimeï¼šMIMEç±»å‹
  - formatï¼šæ ¼å¼ç±»å‹
  - timestampï¼šç”Ÿæˆæ—¶é—´æˆ³
- å†å²è®°å½•
  - é”®ï¼šexport_history_{report_type}_{entity_id}
  - ç»“æ„ï¼šåŒ…å«formatã€filenameã€timestampã€sizeç­‰å­—æ®µï¼Œæœ€å¤šä¿ç•™æœ€è¿‘10æ¡

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L110-L189)
- [page_export.py](file://ui/components/page_export.py#L200-L239)
- [page_export.py](file://ui/components/page_export.py#L393-L457)
- [APIæ–‡æ¡£](file://ui/components/API_DOCUMENTATION.md#L520-L529)

### å¦‚ä½•é›†æˆè‡ªå®šä¹‰æŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼ˆç¤ºä¾‹æµç¨‹ï¼‰
ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºä»æ•°æ®è·å–åˆ°æŠ¥å‘Šç”Ÿæˆçš„å®Œæ•´æµç¨‹ï¼Œé€‚ç”¨äºä»»æ„ä¸šåŠ¡ç”Ÿæˆå‡½æ•°ï¼ˆå¦‚è‚¡ç¥¨æˆ–å¸‚åœºæŠ¥å‘Šï¼‰ã€‚

- æ­¥éª¤1ï¼šå‡†å¤‡æ•°æ®
  - åœ¨ä¸šåŠ¡å±‚ï¼ˆå¦‚stock/stock_report.pyæˆ–market/market_report.pyï¼‰ç»„ç»‡æ‰€éœ€æ•°æ®ï¼Œæ„å»ºæŠ¥å‘Šæ•°æ®ç»“æ„ã€‚
- æ­¥éª¤2ï¼šç”ŸæˆMarkdown
  - å°†æŠ¥å‘Šæ•°æ®è½¬æ¢ä¸ºMarkdownå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚stock_report.pyä¸­çš„generate_markdown_reportï¼‰ã€‚
- æ­¥éª¤3ï¼šæ ¼å¼è½¬æ¢
  - æ ¹æ®format_typeè°ƒç”¨report_utils.pyä¸­çš„å¯¹åº”ç”Ÿæˆå‡½æ•°ï¼š
    - PDFï¼šgenerate_pdf_report(md_content)
    - DOCXï¼šgenerate_docx_report(md_content)
    - HTMLï¼šgenerate_html_report(md_content)
    - Markdownï¼šgenerate_markdown_file(md_content)
- æ­¥éª¤4ï¼šè¿”å›å†…å®¹
  - ç”Ÿæˆå‡½æ•°è¿”å›å­—ç¬¦ä¸²æˆ–äºŒè¿›åˆ¶å†…å®¹ï¼Œä¾›UIå±‚ä¸‹è½½ã€‚
- æ­¥éª¤5ï¼šåœ¨UIä¸­é›†æˆ
  - åœ¨é¡µé¢ä¸­è°ƒç”¨display_report_export_sectionï¼Œä¼ å…¥generate_funcä¸generate_argsã€‚
  - generate_funcå†…éƒ¨å¯å°è£…ä¸šåŠ¡ç”Ÿæˆé€»è¾‘ï¼Œæ¥æ”¶format_typeå¹¶è¿”å›å¯¹åº”æ ¼å¼å†…å®¹ã€‚

```mermaid
flowchart TD
Start(["å¼€å§‹"]) --> GetData["æ”¶é›†ä¸šåŠ¡æ•°æ®"]
GetData --> BuildMD["æ„å»ºMarkdownå†…å®¹"]
BuildMD --> ChooseFormat{"format_type?"}
ChooseFormat --> |pdf| GenPDF["è°ƒç”¨ generate_pdf_report(md)"]
ChooseFormat --> |docx| GenDOCX["è°ƒç”¨ generate_docx_report(md)"]
ChooseFormat --> |html| GenHTML["è°ƒç”¨ generate_html_report(md)"]
ChooseFormat --> |markdown| GenMD["è°ƒç”¨ generate_markdown_file(md)"]
GenPDF --> Return["è¿”å›äºŒè¿›åˆ¶å†…å®¹"]
GenDOCX --> Return
GenHTML --> Return
GenMD --> Return
Return --> UI["UIå±‚æ¥æ”¶å†…å®¹å¹¶å†™å…¥Session State"]
UI --> Download["ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æŒ‰é’®"]
Download --> End(["ç»“æŸ"])
```

å›¾è¡¨æ¥æº
- [stock_report.py](file://stock/stock_report.py#L16-L122)
- [market_report.py](file://market/market_report.py#L13-L87)
- [report_utils.py](file://utils/report_utils.py#L80-L330)
- [page_export.py](file://ui/components/page_export.py#L110-L239)

ç« èŠ‚æ¥æº
- [stock_report.py](file://stock/stock_report.py#L16-L122)
- [market_report.py](file://market/market_report.py#L13-L87)
- [report_utils.py](file://utils/report_utils.py#L80-L330)
- [page_export.py](file://ui/components/page_export.py#L110-L239)

## ä¾èµ–å…³ç³»åˆ†æ
- ç»„ä»¶è€¦åˆ
  - page_export.pyä¾èµ–report_utils.pyæä¾›çš„æ ¼å¼ç”Ÿæˆå‡½æ•°ä¸PDFæ”¯æŒæ£€æµ‹ã€‚
  - é¡µé¢ç»„ä»¶ï¼ˆå¦‚page_stock.pyï¼‰ä¾èµ–page_export.pyæä¾›çš„å¯¼å‡ºç•Œé¢ç»„ä»¶ã€‚
  - ä¸šåŠ¡ç”Ÿæˆå‡½æ•°ï¼ˆstock_report.pyã€market_report.pyï¼‰ä¾èµ–report_utils.pyè¿›è¡Œæ ¼å¼è½¬æ¢ã€‚
- å¤–éƒ¨ä¾èµ–
  - PDFç”Ÿæˆä¾èµ–pandocä¸weasyprint/pandocé»˜è®¤å¼•æ“ã€‚
  - DOCX/HTMLç”ŸæˆåŒæ ·ä¾èµ–pandocã€‚
- æ½œåœ¨å¾ªç¯ä¾èµ–
  - æœªå‘ç°å¾ªç¯ä¾èµ–ï¼šUIç»„ä»¶ä¾èµ–å·¥å…·å±‚ï¼Œä¸šåŠ¡å±‚ä¹Ÿä¾èµ–å·¥å…·å±‚ï¼Œå‡ä¸ºå•å‘ä¾èµ–ã€‚

```mermaid
graph LR
UI["page_export.py"] --> Utils["report_utils.py"]
PageStock["page_stock.py"] --> UI
StockGen["stock_report.py"] --> Utils
MarketGen["market_report.py"] --> Utils
```

å›¾è¡¨æ¥æº
- [page_export.py](file://ui/components/page_export.py#L1-L457)
- [report_utils.py](file://utils/report_utils.py#L1-L330)
- [page_stock.py](file://ui/components/page_stock.py#L1-L200)
- [stock_report.py](file://stock/stock_report.py#L1-L311)
- [market_report.py](file://market/market_report.py#L1-L114)

ç« èŠ‚æ¥æº
- [page_export.py](file://ui/components/page_export.py#L1-L457)
- [report_utils.py](file://utils/report_utils.py#L1-L330)
- [page_stock.py](file://ui/components/page_stock.py#L1-L200)
- [stock_report.py](file://stock/stock_report.py#L1-L311)
- [market_report.py](file://market/market_report.py#L1-L114)

## æ€§èƒ½è€ƒé‡
- ç”Ÿæˆè€—æ—¶
  - PDF/DOCX/HTMLç”Ÿæˆé€šå¸¸è¾ƒæ…¢ï¼Œå»ºè®®åœ¨ä¸šåŠ¡å±‚å°½é‡å‡å°‘ä¸å¿…è¦çš„æ•°æ®æ‹‰å–ä¸æ ¼å¼åŒ–ã€‚
- å¹¶å‘ä¸çŠ¶æ€
  - é€šè¿‡generating_{report_type}_{entity_id}é”®é¿å…é‡å¤ç”Ÿæˆï¼›æ‰¹é‡å¯¼å‡ºæ—¶åº”è€ƒè™‘è¿›åº¦ä¸é”™è¯¯èšåˆã€‚
- å†…å­˜å ç”¨
  - ç”ŸæˆäºŒè¿›åˆ¶å†…å®¹æ—¶æ³¨æ„å†…å­˜å³°å€¼ï¼Œå»ºè®®åœ¨ä¸šåŠ¡å±‚åˆ†å—å¤„ç†æˆ–ç¼“å­˜ä¸­é—´ç»“æœã€‚
- ç¯å¢ƒä¾èµ–
  - PDFç”Ÿæˆä¾èµ–å¤–éƒ¨å·¥å…·ï¼ˆpandocã€weasyprintï¼‰ï¼Œå»ºè®®åœ¨éƒ¨ç½²ç¯å¢ƒä¸­æå‰å®‰è£…å¹¶éªŒè¯å¯ç”¨æ€§ã€‚

## æ•…éšœæ’æŸ¥æŒ‡å—
- PDFä¸å¯ç”¨
  - ç°è±¡ï¼šç•Œé¢ä»…æ˜¾ç¤ºDOCXã€Markdownã€HTMLä¸‰æ ¼å¼ã€‚
  - æ’æŸ¥ï¼šç¡®è®¤pandocä¸weasyprintå‡å·²æ­£ç¡®å®‰è£…å¹¶å¯é€šè¿‡å‘½ä»¤è¡Œè®¿é—®ã€‚
  - å‚è€ƒï¼šreport_utils.pyä¸­çš„ç¯å¢ƒæ£€æµ‹é€»è¾‘ã€‚
- ç”Ÿæˆå¤±è´¥
  - ç°è±¡ï¼šå‡ºç°é”™è¯¯æç¤ºä¸”Session Stateæœªå†™å…¥å†…å®¹ã€‚
  - æ’æŸ¥ï¼šæ£€æŸ¥generate_funcçš„å®ç°ä¸å‚æ•°ä¼ é€’ï¼›ç¡®è®¤ä¸šåŠ¡æ•°æ®å®Œæ•´æ€§ã€‚
- ä¸‹è½½æŒ‰é’®ä¸æ˜¾ç¤º
  - ç°è±¡ï¼šç”ŸæˆæˆåŠŸä½†æœªæ˜¾ç¤ºä¸‹è½½æŒ‰é’®ã€‚
  - æ’æŸ¥ï¼šç¡®è®¤Session Stateä¸­content/filename/mimeç­‰é”®æ˜¯å¦å­˜åœ¨ï¼›æ£€æŸ¥report_typeä¸entity_idæ˜¯å¦åŒ¹é…ã€‚
- æ‰¹é‡å¯¼å‡ºå¼‚å¸¸
  - ç°è±¡ï¼šéƒ¨åˆ†å®ä½“å¯¼å‡ºå¤±è´¥ã€‚
  - æ’æŸ¥ï¼šé€ä¸ªå®ä½“æ£€æŸ¥generate_args_funcä¸generate_funcï¼›å…³æ³¨å¼‚å¸¸æ—¥å¿—å¹¶ç»Ÿè®¡æˆåŠŸæ•°é‡ã€‚

ç« èŠ‚æ¥æº
- [report_utils.py](file://utils/report_utils.py#L1-L46)
- [page_export.py](file://ui/components/page_export.py#L110-L189)
- [page_export.py](file://ui/components/page_export.py#L319-L391)

## ç»“è®º
æœ¬APIå‚è€ƒæ–‡æ¡£ç³»ç»Ÿæ€§åœ°æ¢³ç†äº†æŠ¥å‘Šå¯¼å‡ºç•Œé¢çš„æ ¸å¿ƒç»„ä»¶ä¸Session Stateä½¿ç”¨æ¨¡å¼ï¼Œæ˜ç¡®äº†æ”¯æŒçš„å¯¼å‡ºæ ¼å¼ä¸MIMEç±»å‹ï¼Œå¹¶æä¾›äº†ä»æ•°æ®è·å–åˆ°æŠ¥å‘Šç”Ÿæˆçš„å®Œæ•´é›†æˆç¤ºä¾‹ã€‚é€šè¿‡åˆç†çš„å‚æ•°è®¾è®¡ä¸çŠ¶æ€ç®¡ç†ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸åŒé¡µé¢ä¸­å¿«é€Ÿé›†æˆè‡ªå®šä¹‰æŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼Œå¹¶è·å¾—ä¸€è‡´çš„å¯¼å‡ºä½“éªŒã€‚

## é™„å½•
- æ”¯æŒçš„å¯¼å‡ºæ ¼å¼ä¸MIMEç±»å‹
  - PDFï¼š.pdfï¼Œapplication/pdf
  - DOCXï¼š.docxï¼Œapplication/vnd.openxmlformats-officedocument.wordprocessingml.document
  - Markdownï¼š.mdï¼Œtext/markdown
  - HTMLï¼š.htmlï¼Œtext/html
- Session Stateé”®è§„èŒƒ
  - ç”Ÿæˆä¸­ï¼šgenerating_{report_type}_{entity_id}
  - ç”Ÿæˆå®Œæˆï¼š{report_type}_content_{entity_id}ã€{report_type}_filename_{entity_id}ã€{report_type}_mime_{entity_id}ã€{report_type}_format_{entity_id}ã€{report_type}_timestamp_{entity_id}
  - å†å²è®°å½•ï¼šexport_history_{report_type}_{entity_id}

ç« èŠ‚æ¥æº
- [APIæ–‡æ¡£](file://ui/components/API_DOCUMENTATION.md#L511-L535)
- [page_export.py](file://ui/components/page_export.py#L110-L189)
- [page_export.py](file://ui/components/page_export.py#L393-L457)