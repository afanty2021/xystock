# 核心功能

<cite>
**本文档引用的文件**   
- [main.py](file://main.py)
- [ui/app.py](file://ui/app.py)
- [ui/components/page_market_overview.py](file://ui/components/page_market_overview.py)
- [ui/components/page_stock.py](file://ui/components/page_stock.py)
- [ui/components/page_cache_management.py](file://ui/components/page_cache_management.py)
- [ui/components/page_token_stats.py](file://ui/components/page_token_stats.py)
- [ui/components/page_settings.py](file://ui/components/page_settings.py)
- [market/market_report.py](file://market/market_report.py)
- [stock/stock_report.py](file://stock/stock_report.py)
- [backtesting/backtest.py](file://backtesting/backtest.py)
- [market/market_ai_analysis.py](file://market/market_ai_analysis.py)
- [stock/stock_ai_analysis.py](file://stock/stock_ai_analysis.py)
- [config_default.toml](file://config_default.toml)
</cite>

## 目录
1. [大盘分析](#大盘分析)
2. [个股分析](#个股分析)
3. [AI智能分析](#ai智能分析)
4. [策略回测](#策略回测)
5. [系统管理](#系统管理)
6. [功能协同与数据流转](#功能协同与数据流转)

## 大盘分析

大盘分析模块为用户提供全面的市场概览，帮助用户把握整体市场趋势。该模块支持对上证指数、深证成指、创业板指、科创50等主要大盘指数的行情预测与智能分析。

用户通过主界面的侧边栏功能菜单选择“大盘分析”进入该模块。在分析页面，用户首先从下拉菜单中选择要分析的特定指数（如上证指数）。随后，用户可选择是否启用“AI大盘分析”功能，并可输入个人对大盘的观点或关注重点。点击“开始分析”按钮后，系统将整合多维度数据并生成分析报告。

该模块的核心功能包括：
- **市场概览**：实时显示主要指数的当前价格、涨跌幅和成交量，提供直观的市场整体表现。
- **技术分析**：展示所选指数的K线图、成交量图，并分析移动平均线（MA）、MACD、RSI等技术指标，评估市场趋势。
- **基本面分析**：提供市场估值水平（如市盈率PE、股息率）、资金流向（M1/M2余额及增长率）以及融资融券数据，反映市场的基本面状况。
- **市场情绪分析**：综合多个维度的市场情绪指标，如投资者情绪、市场热度等，评估市场参与者的情绪状态。
- **综合摘要**：当启用AI分析时，系统会生成一份深度的综合分析报告，整合技术、资金、情绪等多方面信息，提供投资建议和风险提示。

**Section sources**
- [ui/app.py](file://ui/app.py#L72-L81)
- [ui/components/page_market_overview.py](file://ui/components/page_market_overview.py#L627-L758)

## 个股分析

个股分析模块为用户提供针对具体股票的深度分析，涵盖基本信息、基本面、技术面、新闻、筹码等多个维度。

用户通过主界面的“股票分析”功能进入该模块。在查询页面，用户需选择市场类型（A股、港股、ETF等），输入股票代码或名称。用户可选择是否启用“AI智能分析”功能，并可输入个人对该股票的观点和当前持仓状态。点击“查询”按钮后，系统将获取数据并展示分析结果。

该模块的核心功能包括：
- **基本信息**：展示股票的实时价格、涨跌幅、成交量、总市值、流通市值、市盈率、市净率等核心数据。
- **基本面分析**：深入分析公司的盈利能力、偿债能力、营运能力、成长能力等财务指标，并提供股息分红历史与收益潜力分析。
- **技术面分析**：展示股票的K线图和成交量图，分析技术指标（如MA、MACD、RSI），并进行风险评估。
- **新闻分析**：聚合与该股票相关的最新新闻资讯，并可进行AI新闻分析，评估新闻事件对股价的潜在影响。
- **筹码分析**：分析A股和基金的筹码分布、获利比例、平均成本、支撑位和阻力位，帮助用户判断主力动向和市场博弈情况。
- **ETF持仓分析**：对于ETF基金，提供其详细的持仓股票列表、持仓市值占比和集中度分析。

**Section sources**
- [ui/app.py](file://ui/app.py#L74-L75)
- [ui/components/page_stock.py](file://ui/components/page_stock.py#L47-L800)

## AI智能分析

AI智能分析是xystock的核心功能，它通过整合多维度数据，利用大语言模型（LLM）生成深度的投资建议，将零散的数据转化为有推理过程的结论。

该功能在大盘分析和个股分析模块中均可启用。当用户勾选“AI智能分析”选项后，系统会调用配置的LLM服务（如DeepSeek、GPT-4等）进行深度分析。分析过程如下：
1.  **数据收集**：系统自动收集与分析对象相关的所有数据，包括实时行情、技术指标、基本面数据、新闻资讯、市场情绪、用户观点和用户画像等。
2.  **提示词工程**：系统根据分析类型（技术、基本面、新闻、筹码、综合）和用户的风险偏好，构建结构化的系统提示词（System Prompt），引导模型进行专业、客观的分析。
3.  **模型调用**：将收集到的数据和精心设计的提示词发送给LLM，请求生成分析报告。
4.  **结果整合**：将模型返回的分析结果整合到用户界面中，以清晰的格式展示。

AI智能分析能够：
- **整合多源信息**：将技术、基本面、消息面、筹码面等不同维度的信息融合，形成全面的视角。
- **提供个性化建议**：结合用户输入的观点、持仓状态和常犯错误，提供量身定制的操作建议和风险提醒。
- **生成可解释的结论**：避免“黑盒”操作，提供有推理过程的分析，让用户了解建议背后的逻辑。
- **支持多种分析类型**：分别对技术面、基本面、新闻、筹码进行专项分析，并最终生成一份综合性的投资决策报告。

**Section sources**
- [ui/components/page_market_overview.py](file://ui/components/page_market_overview.py#L364-L413)
- [ui/components/page_stock.py](file://ui/components/page_stock.py#L472-L799)
- [market/market_ai_analysis.py](file://market/market_ai_analysis.py#L14-L123)
- [stock/stock_ai_analysis.py](file://stock/stock_ai_analysis.py#L347-L800)

## 策略回测

策略回测模块为用户提供了一个验证投资策略有效性的工具，帮助用户在投入真金白银之前，通过历史数据测试策略的盈利能力。

该模块基于`backtesting/backtest.py`文件中的`SimpleBacktest`类实现。用户可以定义自己的交易策略（如基于技术指标的买卖信号），然后在历史数据上运行回测。

回测过程包括：
1.  **策略定义**：用户编写一个策略函数，该函数接收当前的市场数据和回测状态，返回“买入”、“卖出”或“持有”的交易信号。
2.  **数据输入**：系统提供历史K线数据作为回测的输入。
3.  **模拟交易**：回测引擎根据策略信号，模拟执行买卖操作，并记录交易记录和资产变化。
4.  **绩效评估**：回测完成后，系统计算并展示关键绩效指标，包括：
    - **总收益率**：策略在整个回测期间的总回报。
    - **年化收益率**：将总收益率折算为年化水平。
    - **最大回撤**：策略在回测期间经历的最大资金缩水幅度。
    - **夏普比率**：衡量策略的风险调整后收益。
    - **胜率**：盈利交易次数占总交易次数的比例。

通过策略回测，用户可以客观地评估一个策略的优劣，优化参数，并增强对策略的信心。

**Section sources**
- [backtesting/backtest.py](file://backtesting/backtest.py#L11-L207)

## 系统管理

系统管理功能为用户提供对工具运行环境和配置的控制，确保系统高效、稳定地运行。

该模块包含三个主要子功能，均通过侧边栏菜单访问：
- **缓存管理**：提供清理股票数据缓存和大盘数据缓存的功能。清理缓存后，下次查询将强制获取最新数据，但会增加数据获取时间。用户也可以选择一键清理所有缓存。
- **Token统计**：详细记录和统计LLM API的调用情况，包括总请求数、总Token数、平均响应时间、成功率等。用户可以查看不同模型的使用分布和详细的调用日志，以便监控和优化使用成本。
- **系统设置**：允许用户配置核心参数，包括：
    - **OpenAI API设置**：输入API密钥、Base URL，以及选择分析模型和推理模型。
    - **分析偏好设置**：选择分析的风险偏好（中性、保守、激进等），影响AI生成建议的风格。
    - **用户画像**：输入个人的投资偏好、擅长领域和常犯的错误，使AI分析更具个性化。

**Section sources**
- [ui/components/page_cache_management.py](file://ui/components/page_cache_management.py#L13-L133)
- [ui/components/page_token_stats.py](file://ui/components/page_token_stats.py#L17-L189)
- [ui/components/page_settings.py](file://ui/components/page_settings.py#L22-L216)
- [config_default.toml](file://config_default.toml#L1-L64)

## 功能协同与数据流转

xystock的各个功能模块并非孤立存在，而是通过精心设计的数据流转和功能协同，形成了一个完整的投资决策支持系统。

其工作流程和协同关系如下：
1.  **数据获取与缓存**：系统通过`market_data_fetcher.py`和`stock_data_fetcher.py`等模块从外部源获取实时和历史数据。为了提高效率和降低成本，这些数据会被缓存（Cache），并在后续查询中优先使用。
2.  **AI分析驱动**：无论是大盘分析还是个股分析，其核心深度分析都由AI智能分析模块驱动。该模块作为“大脑”，从各个数据源（市场、个股、新闻、用户）收集信息，通过LLM生成综合报告。
3.  **功能模块集成**：用户界面（UI）作为“门户”，将不同的功能模块（大盘、个股、回测、管理）集成在一起。例如，在个股分析中，AI综合分析会主动调用大盘分析的结果，以确保个股分析是在正确的市场大趋势下进行的。
4.  **报告导出**：`stock_report.py`和`market_report.py`模块负责将分析结果整合成结构化的报告，并通过`report_utils.py`支持导出为PDF、Word、Markdown等多种格式，方便用户分享和存档。
5.  **系统管理支撑**：系统管理功能为整个系统提供支撑。Token统计帮助用户控制成本，缓存管理平衡了数据新鲜度和查询速度，系统设置则允许用户根据个人需求定制分析体验。

这种协同工作模式使得xystock不仅能提供数据，更能提供有深度、有逻辑、个性化的投资洞察，帮助用户做出更明智的决策。

**Section sources**
- [ui/app.py](file://ui/app.py#L32-L82)
- [market/market_report.py](file://market/market_report.py#L13-L114)
- [stock/stock_report.py](file://stock/stock_report.py#L16-L311)
- [utils/report_utils.py](file://utils/report_utils.py#L1-L330)